@using HE_THONG_QUAN_LY_CUA_HANG_TIEN_LOI_247_WEB.Models.Entities

@{
    ViewData["title"] = "Thanh Toán Hóa Đơn";

    var hoaDon = ViewData["HoaDon"] as HoaDon;
    var lstKenhThanhToan = ViewData["DanhSachKenhThanhToan"] as List<KenhThanhToan>;

    decimal tongTien = hoaDon?.TongTien ?? 0;
}

<link rel="stylesheet" href="~/assets/css/ThanhToanHoaDon.css" asp-append-version="true">

<main class="app-content">
    <div class="app-title">
        <div>
            <h1><i class="bi bi-credit-card"></i> Thanh Toán Hóa Đơn</h1>
            <p>Mã hóa đơn: <strong>@hoaDon?.Id</strong></p>
        </div>
        <ul class="app-breadcrumb breadcrumb">
            <li class="breadcrumb-item"><i class="bi bi-house-door fs-6"></i></li>
            <li class="breadcrumb-item"><a asp-controller="QuanLyHoaDon" asp-action="DanhSachHoaDon">Danh sách hóa đơn</a></li>
            <li class="breadcrumb-item active">Thanh toán</li>
        </ul>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="tile pos-total-card">
                <div class="tile-body">
                    <h5 class="card-title text-muted">$ TỔNG CỘNG PHẢI THANH TOÁN</h5>
                    <div class="pos-total-amount">
                        @tongTien.ToString("N0") đ
                    </div>
                    <div class="pos-total-note">Đã bao gồm VAT và giảm giá</div>
                </div>
            </div>


            <div class="tile">
                <div class="tile-body">
                    <label class="form-label fw-bold">Chọn Phương Thức Thanh Toán:</label>
                    <div class="d-grid gap-2 payment-method-buttons">
                        @if (lstKenhThanhToan != null)
                        {
                            bool isFirstCashButton = true;
                            foreach (var kenh in lstKenhThanhToan)
                            {
                                var isActiveCash = kenh.LoaiKenh == "TienMat" && isFirstCashButton ? "active" : "";
                                if (kenh.LoaiKenh == "TienMat" && isFirstCashButton)
                                {
                                    isFirstCashButton = false;
                                }
                                
                                <button class="btn btn-outline-secondary btn-lg payment-method-btn @isActiveCash"
                                        data-id="@kenh.Id"
                                        data-type="@kenh.LoaiKenh"
                                        data-name="@kenh.TenKenh">
                                    @if (kenh.LoaiKenh == "TienMat")
                                    {
                                        <i class="bi bi-cash-stack me-2"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-qr-code me-2"></i>
                                    }
                                    @kenh.TenKenh
                                </button>
                            }
                        }
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Ngày Giao Dịch:</label>
                        <input class="form-control" type="text" value="@DateTime.Now.ToString("dd/MM/yyyy")" disabled>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">

            <div class="tile" id="cash-payment-panel">
                <h3 class="tile-title"><i class="bi bi-cash"></i> Thanh Toán Tiền Mặt</h3>
                <div class="tile-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tiền Khách Đưa (*):</label>
                        <input class="form-control form-control-lg" type="number" id="cash-received"
                               placeholder="Nhập số tiền khách trả">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gợi ý mệnh giá:</label>
                        <div class="suggestion-buttons">
                            @{
                                decimal roundedTotal = Math.Ceiling(tongTien / 1000) * 1000;
                                var suggestions = new List<decimal> { roundedTotal };
                                if (roundedTotal < 210000 && 210000 > tongTien) suggestions.Add(210000);
                                if (roundedTotal < 300000 && 300000 > tongTien) suggestions.Add(300000);
                                if (roundedTotal < 500000 && 500000 > tongTien) suggestions.Add(500000);
                                if (roundedTotal < 1000000 && 1000000 > tongTien) suggestions.Add(1000000);

                                foreach (var amount in suggestions.Distinct().OrderBy(a => a).Take(4))
                                {
                                    <button class="btn btn-outline-secondary btn-sm btn-suggestion me-2 mb-2"
                                            data-amount="@amount">
                                        @amount.ToString("N0") đ
                                    </button>
                                }
                            }
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tiền Thối Lại (Trả Khách):</label>
                        <div class="pos-change-box" id="change-display">Vui lòng nhập tiền khách đưa</div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Ghi chú:</label>
                        <textarea class="form-control" id="payment-note-cash" rows="2"
                                  placeholder="Ghi chú thêm (nếu có)"></textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="complete-payment-btn-cash">
                            <i class="bi bi-check-circle-fill me-2"></i>Hoàn Tất Giao Dịch
                        </button>
                        <a href="/QuanLyHoaDon/DanhSachHoaDon" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>Hủy
                        </a>
                    </div>
                </div>
            </div>

            <div class="tile d-none" id="qr-payment-panel">
                <h3 class="tile-title"><i class="bi bi-qr-code-scan"></i> Thanh Toán QR Code</h3>
                <div class="tile-body text-center">
                    <p class="text-center">Khách hàng quét mã QR để thanh toán <strong>@tongTien.ToString("N0") đ</strong></p>
                    <img src="https://api.vietqr.io/image/970436-1133666888-OkdEItT.jpg?amount=@tongTien&addInfo=@(hoaDon?.Id)_@DateTime.Now.Ticks"
                         alt="QR Code Thanh Toán" class="img-fluid mt-3 mb-3" style="max-width: 300px;">
                    <p class="text-muted">Chờ xác nhận thanh toán từ hệ thống...</p>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Ghi chú:</label>
                        <textarea class="form-control" id="payment-note-qr" rows="2"
                                  placeholder="Ghi chú thêm (nếu có)"></textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" id="complete-payment-btn-qr">
                            <i class="bi bi-check-circle-fill me-2"></i>Xác Nhận Đã Thanh Toán
                        </button>
                        <a href="/QuanLyHoaDon/DanhSachHoaDon" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>Hủy
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <input type="hidden" id="hoa-don-id" value="@hoaDon?.Id" />
    <input type="hidden" id="tong-tien" value="@tongTien" />
    <input type="hidden" id="nhan-vien-id" value="@hoaDon?.NhanVienId" />
</main>

<script src="~/assets/js/ThanhToanHoaDon.js" asp-append-version="true" defer></script>