@using HE_THONG_QUAN_LY_CUA_HANG_TIEN_LOI_247_WEB.Models.Entities;

@{
    ViewData["title"] = "Thêm Hóa Đơn";
    
    var lstKhachHang = ViewData["DanhSachKhachHang"] as List<KhachHang>;
    var lstSanPhamDonVi = ViewData["DanhSachSanPhamDonVi"] as List<SanPhamDonVi>;
    var lstDanhMuc = ViewData["DanhSachDanhMuc"] as List<DanhMuc>;
    var lstMaKhuyenMai = ViewData["DanhSachMaKhuyenMai"] as List<MaKhuyenMai>;
}
  <!-- Css riêng ở đây nha -->
  <link rel="stylesheet" href="~/assets/lib/select2/dist/css/select2.min.css">
  <link rel="stylesheet" type="text/css" href="~/assets/css/ThemHoaDon.css">


  <main class="app-content">
    <div class="app-title">
      <div>
        <h1><i class="bi bi-receipt-cutoff"></i> Tạo Hoá Đơn Bán Hàng (POS)</h1>
        <p>Bán hàng tại quầy</p>
      </div>
      <ul class="app-breadcrumb breadcrumb">
        <li class="breadcrumb-item"><i class="bi bi-house-door fs-6"></i></li>
        <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="QuanLyHoaDon" asp-action="DanhSachHoaDon">Danh sách hóa đơn</a></li>
        <li class="breadcrumb-item active"><a asp-area="Admin" asp-controller="Them" asp-action="ThemHoaDon">Tạo hoá đơn</a></li>
      </ul>
    </div>
    <div class="row">

      <div class="col-md-7">
        <div class="tile">
          <h3 class="tile-title">Chi tiết Hoá Đơn</h3>
          <div class="tile-body">

            <div class="row mb-3">
              <div class="col-md-9">
                <label class="form-label">Khách hàng</label>
                <select class="form-control" id="selectKhachHang" style="width: 100%;">
                  <option value="">Khách lẻ</option>
                  @if (lstKhachHang != null)
                  {
                      foreach (var kh in lstKhachHang)
                      {
                          <option value="@kh.Id">@kh.HoTen</option>
                      }
                  }
                </select>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <a class="btn btn-primary" href="/Them/ThemKhachHang" target="_blank">
                  <i class="bi bi-plus-lg"></i> Thêm mới
                </a>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Sản phẩm</th>
                    <th style="width: 100px;">Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Mã giảm giá</th>
                    <th>Thành tiền</th>
                    <th style="width: 50px;">Xoá</th>
                  </tr>
                </thead>
                <tbody id="invoice-items-body">
                  <tr class="text-center text-muted">
                    <td colspan="6">Chưa có sản phẩm nào. Hãy thêm sản phẩm từ danh sách bên phải.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="row mt-3 justify-content-end">
              <div class="col-md-6">
                <h5 class="fw-normal">Tạm tính: <span id="sub-total" class="float-end">0 đ</span></h5>
                <h5>Giảm giá: <span id="discount-amount" class="float-end text-danger">0 đ</span></h5>
                <hr>
                <h4 class="fw-bold">Tổng cộng: <span id="total-amount" class="float-end text-primary">0 đ</span></h4>
              </div>
            </div>
          </div>

          <div class="tile-footer text-end">
            <button class="btn btn-secondary" type="button" id="cancel-invoice-btn">
              <i class="bi bi-x-circle me-2"></i>Huỷ
            </button>

            <button class="btn btn-primary" type="button" id="save-draft-btn">
              <i class="bi bi-save me-2"></i>Lưu tạm
            </button>

            <button class="btn btn-success" type="button" id="complete-invoice-btn">
              <i class="bi bi-wallet me-2"></i>Thanh toán ngay
            </button>
          </div>
        </div>
      </div>

      <div class="col-md-5">

        <div class="tile">
          <h3 class="tile-title">Danh sách Sản phẩm</h3>

        <div class="input-group mb-3">
            <input type="text" class="form-control" id="product-search-input" placeholder="Tìm kiếm sản phẩm (tên hoặc mã)~">
            <button class="btn btn-outline-primary" type="button" id="btn-scan-barcode" title="Quét mã vạch">
                <i class="bi bi-qr-code-scan"></i> </button>
        </div>

        <div id="scanner-container" class="card mb-3" style="display:none;">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span><i class="bi bi-camera-video"></i> Quét Mã: </span>
                    <select id="camera-select" class="form-select form-select-sm ms-2 text-dark" style="max-width: 250px; display: none;"></select>
                </div>
                <button type="button" class="btn-close btn-close-white" id="btn-close-camera" aria-label="Close"></button>
            </div>
            <div class="card-body p-0">
                <div id="reader" style="width: 100%;"></div>
            </div>
        </div>

          <div class="mb-3">
            <select class="form-control" id="selectDanhMuc">
              <option value="">Tất cả danh mục</option>
              @if (lstDanhMuc != null)
              {
                  foreach (var dm in lstDanhMuc)
                  {
                      <option value="@dm.Id">@dm.Ten</option>
                  }
              }
            </select>
          </div>

          <div class="product-list-container">
            <ul class="list-group" id="product-list">
              @if (lstSanPhamDonVi != null && lstSanPhamDonVi.Any())
              {
                @foreach (var sp in lstSanPhamDonVi)
                {
                    var tenSanPham = sp.SanPham?.Ten ?? sp.Id;
                    var tenDonVi = sp.DonVi?.Ten ?? "";
                    var tenHienThi = string.IsNullOrEmpty(tenDonVi) ? tenSanPham : $"{tenSanPham} ({tenDonVi})";
                    var giaBan = sp.GiaBan;
                    var danhMucId = sp.SanPham?.SanPhamDanhMucs?.FirstOrDefault()?.DanhMucId ?? "";

                    // --- SỬA LOGIC LẤY MÃ VẠCH ---
                    // Lấy tất cả mã vạch của sản phẩm này, nối lại thành 1 chuỗi string ví dụ: "893001 893002"
                    var listBarcodes = sp.MaDinhDanhSanPhams?
                                        .Where(x => x.LoaiMa == "Barcode" && !string.IsNullOrEmpty(x.MaCode))
                                        .Select(x => x.MaCode)
                                        .ToList();
    
                    // Nối thành chuỗi để gán vào data attribute cho dễ tìm kiếm
                    var barcodeString = (listBarcodes != null && listBarcodes.Any()) 
                                        ? string.Join(" ", listBarcodes) 
                                        : "";

                    <li class="list-group-item d-flex justify-content-between align-items-center product-item"
                        data-category="@danhMucId"
                        data-product-id="@sp.Id"
                        data-product-name="@tenHienThi"
                        data-product-price="@giaBan"
                        data-product-barcodeId="@barcodeString"> <div>
                            <h6 class="mb-0">@tenSanPham</h6>
                            <small class="text-muted">
                                @giaBan.ToString("N0") đ
                                @if (!string.IsNullOrEmpty(tenDonVi))
                                {
                                    <text> / @tenDonVi</text>
                                }
                            </small>
                            @if(listBarcodes != null && listBarcodes.Any()){
                                 <br><small class="text-secondary" style="font-size: 0.75rem;"><i class="bi bi-upc"></i> @listBarcodes.First() ...</small>
                            }
                        </div>
                        <button class="btn btn-primary btn-sm add-product-btn" 
                                data-id="@sp.Id"
                                data-name="@tenHienThi"
                                data-price="@giaBan">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </li>
                }
              }
              else
              {
                  <li class="list-group-item text-center text-muted">
                      Không có sản phẩm nào
                  </li>
              }
            </ul>
          </div>
        </div>

        <div class="tile">
          <h3 class="tile-title">Hoá Đơn Tạm Lưu</h3>
          <div class="draft-list-container">
            <ul class="list-group" id="draft-list">
              <li class="list-group-item text-center text-muted">
                Chưa có hóa đơn tạm lưu nào
              </li>
            </ul>
          </div>
        </div>

      </div>
    </div>
    <script>
        var danhSachKhuyenMai = @Html.Raw(Json.Serialize(
            (lstMaKhuyenMai != null) ? lstMaKhuyenMai
            
                .Where(x => !x.IsDelete 
                            && x.TrangThai == "Hoạt động" 
                            && x.SoLanSuDung > 0
                            && (x.ChuongTrinh == null || (DateTime.Now >= x.ChuongTrinh.NgayBatDau && DateTime.Now <= x.ChuongTrinh.NgayKetThuc)))
            
                .Select(x => {
               
                    var dieuKien = x.ChuongTrinh?.DieuKienApDungs?.FirstOrDefault();
                    var ct = x.ChuongTrinh; 

                    return new {
                        id = x.Id,
                        ma = x.Code,
                        giaTri = x.GiaTri, 
                    
                        loaiGiam = dieuKien?.GiamTheo ?? "Giá tiền", 
                        toithieu = dieuKien?.GiaTriToiThieu ?? 0,   
                        toida = dieuKien?.GiaTriToiDa ?? 999999999,  
                    
                        ngayBatDau = ct?.NgayBatDau, 
                        ngayKetThuc = ct?.NgayKetThuc
                    };
                }) 
                : new List<object>()
        ));
    </script>
    <!-- Hidden data for JavaScript -->
  </main>

  <!-- js riêng ở đây nha! -->
  <script src="~/assets/lib/jquery/jquery-3.7.0.min.js"></script>
  <script src="~/assets/lib/select2/dist/js/select2.min.js"></script>
  <script src="~/assets/js/ThemHoaDon.js" asp-append-version="true" defer></script>
  @* quét mã *@
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
